<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Interattivo</title>
  <style>
    /* --- STILI --- */
    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #1c1f2b;
      color: #fff;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 30px;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .card {
      background-color: #2a2e3d;
      color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .risposta {
      background-color: #ffffff;
      color: #000;
      border: 2px solid #ccc;
      margin: 10px 0;
      padding: 15px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      transition: 0.3s;
    }
    .corretta {
      background-color: #28a745;
      color: white;
      border-color: #28a745;
    }
    .sbagliata {
      background-color: #dc3545;
      color: white;
      border-color: #dc3545;
    }
    button {
      padding: 10px 16px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      background-color: #1a73e8;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #155ab6;
    }
    .btn-danger {
      background-color: #d93025;
    }
    .btn-danger:hover {
      background-color: #b5271b;
    }
    #risposte {
      display: grid;
      gap: 1rem;
    }
  </style>
</head>
<body>
  <div id="start-container" style="text-align: center; margin-bottom: 30px;">
    <button onclick="iniziaQuiz()">üé§ Avvia Quiz</button>
  </div>

  <h1 style="display:none;" id="titolo-quiz">Quiz a Scelta Multipla</h1>

  <div class="stats" id="stats-container" style="display:none;">
    <div><strong>Punteggio:</strong> <span id="punteggio">0</span></div>
    <div><strong>Domanda:</strong> <span id="contatore">0</span>/20</div>
  </div>

  <div class="progress-container" style="background-color: #444; border-radius: 30px; margin-bottom: 20px; overflow: hidden;">
    <div id="progress-bar" style="width: 0%; height: 14px; background: linear-gradient(to right, #ff416c, #ff4b2b); transition: width 0.4s;"></div>
  </div>

  <div class="card" id="card-container" style="display:none;">
    <div id="domanda" style="font-size: 1.4em; font-weight: bold; border: 2px solid #007bff; padding: 20px; border-radius: 10px; background-color: #2a2e3d; color: white; margin-bottom: 20px;">Caricamento...</div>
    <div id="risposte"></div>
    <div id="feedback" style="margin-top: 15px;"></div>
  </div>

  <div class="controls" id="controls-container" style="display:none; text-align:center;">
    <button onclick="prossimaDomanda()">‚û°Ô∏è Avanti</button>
    <button class="btn-danger" onclick="terminaTest()">üõë Termina Test</button>
    <button onclick="ricomincia()">üîÑ Ricomincia</button>
  </div>

  <div id="recap"></div>

  <script>
    let rispostaCorretta = "";
    let punteggio = 0;
    let ultimaDomanda = null;
    let risposteUtente = [];
    let indexDomanda = 0;
    const MAX_DOMANDE = 20;

    async function fetchDomanda(index) {
      const res = await fetch(`/sequenza/${index}`);
      return await res.json();
    }

    async function caricaDomanda() {
      if (indexDomanda >= MAX_DOMANDE) {
        mostraRecap();
        return;
      }

      const domandaData = await fetchDomanda(indexDomanda);
      ultimaDomanda = domandaData;

      document.getElementById('domanda').textContent = domandaData.domanda;
      document.getElementById('contatore').textContent = indexDomanda + 1;
      document.getElementById('progress-bar').style.width = Math.floor(((indexDomanda + 1) / MAX_DOMANDE) * 100) + "%";
      rispostaCorretta = domandaData.corretta;

      const risposte = [...domandaData.risposte].sort(() => Math.random() - 0.5);
      const container = document.getElementById('risposte');
      container.innerHTML = "";
      document.getElementById('feedback').textContent = "";

      risposte.forEach(r => {
        const btn = document.createElement('div');
        btn.className = 'risposta';
        btn.textContent = r;
        btn.onclick = () => verificaRisposta(btn, r);
        container.appendChild(btn);
      });
    }

    function verificaRisposta(elemento, rispostaUtente) {
      const tutte = document.querySelectorAll('.risposta');
      tutte.forEach(el => el.onclick = null);

      if (rispostaUtente === rispostaCorretta) {
        elemento.classList.add('corretta');
        document.getElementById('feedback').textContent = "‚úÖ Corretto!";
        punteggio++;
      } else {
        elemento.classList.add('sbagliata');
        document.getElementById('feedback').textContent = "‚ùå Sbagliato!";
        tutte.forEach(el => {
          if (el.textContent === rispostaCorretta) el.classList.add('corretta');
        });
      }

      document.getElementById('punteggio').textContent = punteggio;
      risposteUtente.push({
        domanda: ultimaDomanda.domanda,
        rispostaUtente,
        corretta: rispostaCorretta,
        esito: rispostaUtente === rispostaCorretta
      });
    }

    function prossimaDomanda() {
      indexDomanda++;
      caricaDomanda();
    }

    function mostraRecap() {
      document.getElementById('domanda').textContent = "üìä Test completato!";
      document.getElementById('risposte').innerHTML = "";
      document.getElementById('feedback').textContent = "";

      let recapHTML = "<h2>Riepilogo Risposte</h2>";
      recapHTML += "<div>";
      risposteUtente.forEach((item, i) => {
        const corretta = item.rispostaUtente === item.corretta;
        recapHTML += `
          <div class='domandaRecap'>
            <div><strong>${i + 1}. ${item.domanda}</strong></div>
            ${!corretta ? `<div><strong>Tua risposta:</strong> <span style="color:red;">${item.rispostaUtente}</span></div>` : ``}
            <div><strong>Risposta corretta:</strong> <span style="color:green;">${item.corretta}</span></div>
            <div><strong>Esito:</strong> ${item.esito ? '‚úÖ Corretto' : '‚ùå Sbagliato'}</div>
          </div>
        `;
      });
      document.getElementById('recap').innerHTML = recapHTML;
    }

    function ricomincia() {
      punteggio = 0;
      indexDomanda = 0;
      risposteUtente = [];
      document.getElementById('punteggio').textContent = "0";
      document.getElementById('recap').innerHTML = "";
      caricaDomanda();
    }

    function terminaTest() {
      indexDomanda = MAX_DOMANDE;
      mostraRecap();
    }

    function iniziaQuiz() {
      document.getElementById('start-container').style.display = 'none';
      document.getElementById('titolo-quiz').style.display = 'block';
      document.getElementById('stats-container').style.display = 'flex';
      document.getElementById('card-container').style.display = 'block';
      document.getElementById('controls-container').style.display = 'block';
      caricaDomanda();
    }
  </script>
</body>
</html>
