<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interattivo</title>
    <style>
        /* --- Il tuo CSS rimane invariato --- */
        /* (omesso qui per brevit√†, copia quello che mi hai passato) */
    </style>
</head>
<body>
    <div id="start-container" style="text-align: center; margin-bottom: 30px;">
        <button onclick="iniziaQuiz()">üé§ Avvia Quiz</button>
    </div>
    <h1 style="display:none;" id="titolo-quiz">Quiz a Scelta Multipla</h1>
    <div class="stats" id="stats-container" style="display:none;">
        <div><strong>Punteggio:</strong> <span id="punteggio">0</span></div>
        <div><strong>Domanda:</strong> <span id="contatore">0</span>/15</div>
    </div>

    <div class="progress-container" style="background-color: #444; border-radius: 30px; margin-bottom: 20px; overflow: hidden;">
        <div id="progress-bar" style="width: 0%; height: 14px; background: linear-gradient(to right, #ff416c, #ff4b2b); transition: width 0.4s;"></div>
    </div>

    <div class="card" id="card-container" style="display:none; border-radius: 20px; padding: 30px;">
        <div id="domanda">Caricamento...</div>
        <div id="risposte"></div>
        <div id="feedback" style="margin-top: 15px;"></div>
    </div>

    <div class="controls controls-container" style="display:none;" id="controls-container">
        <button onclick="caricaDomanda()">Avanti</button>
        <button class="btn-danger" onclick="terminaTest()">üõë Termina Test</button>
        <button onclick="ricomincia()">üîÑ Ricomincia</button>
    </div>

    <div id="recap"></div>

    <script>
        let rispostaCorretta = "";
        let punteggio = 0;
        let tutteDomande = [];
        let domandeEstratte = [];
        let ultimaDomanda = null;
        let risposteUtente = [];
        const MAX_DOMANDE = 15;

        const quizName = "{{ quiz_name }}";  // viene passato dal backend

        async function fetchTutteDomande() {
            const res = await fetch(`/quiz/${quizName}/data`);
            tutteDomande = await res.json();

            // adatta i campi se nel JSON usi "question"/"options"/"answer"
            domandeEstratte = tutteDomande.map(q => ({
                domanda: q.question,
                risposte: q.options,
                corretta: q.answer
            })).sort(() => Math.random() - 0.5).slice(0, MAX_DOMANDE);

            caricaDomanda();
        }

        function caricaDomanda() {
            if (risposteUtente.length >= MAX_DOMANDE) {
                mostraRecap();
                return;
            }

            const domandaData = domandeEstratte[risposteUtente.length];
            ultimaDomanda = domandaData;

            document.getElementById('domanda').textContent = domandaData.domanda;
            rispostaCorretta = domandaData.corretta;

            const container = document.getElementById('risposte');
            container.innerHTML = "";
            domandaData.risposte.sort(() => Math.random() - 0.5).forEach(r => {
                const btn = document.createElement('div');
                btn.className = 'risposta';
                btn.textContent = r;
                btn.onclick = () => verificaRisposta(btn, r);
                container.appendChild(btn);
            });
        }

        function verificaRisposta(elemento, rispostaUtente) {
            const tutte = document.querySelectorAll('.risposta');
            tutte.forEach(el => el.onclick = null);

            if (rispostaUtente === rispostaCorretta) {
                elemento.classList.add('corretta');
                document.getElementById('feedback').textContent = "‚úÖ Corretto!";
                punteggio++;
            } else {
                elemento.classList.add('sbagliata');
                document.getElementById('feedback').textContent = "‚ùå Sbagliato!";
                tutte.forEach(el => {
                    if (el.textContent === rispostaCorretta) el.classList.add('corretta');
                });
            }

            document.getElementById('punteggio').textContent = punteggio;
            risposteUtente.push({
                domanda: ultimaDomanda.domanda,
                rispostaUtente,
                corretta: rispostaCorretta,
                esito: rispostaUtente === rispostaCorretta
            });
        }

        function mostraRecap() {
            document.getElementById('domanda').textContent = "üìä Test completato!";
            document.getElementById('risposte').innerHTML = "";
            document.getElementById('feedback').textContent = "";

            let recapHTML = "<h2>Riepilogo Risposte</h2>";
            risposteUtente.forEach((item, i) => {
                recapHTML += `
                    <div class='domandaRecap'>
                        <div><strong>${i + 1}. ${item.domanda}</strong></div>
                        <div><strong>Tua risposta:</strong> ${item.rispostaUtente}</div>
                        <div><strong>Corretta:</strong> ${item.corretta}</div>
                        <div><strong>Esito:</strong> ${item.esito ? "‚úÖ" : "‚ùå"}</div>
                    </div>
                `;
            });
            document.getElementById('recap').innerHTML = recapHTML;
        }

        function ricomincia() {
            punteggio = 0;
            risposteUtente = [];
            document.getElementById('punteggio').textContent = "0";
            document.getElementById('recap').innerHTML = "";
            fetchTutteDomande();
        }

        function terminaTest() {
            risposteUtente = domandeEstratte.map(d => ({
                domanda: d.domanda,
                rispostaUtente: "Non risposto",
                corretta: d.corretta,
                esito: false
            }));
            mostraRecap();
        }

        function iniziaQuiz() {
            document.getElementById('start-container').style.display = 'none';
            document.getElementById('titolo-quiz').style.display = 'block';
            document.getElementById('stats-container').style.display = 'flex';
            document.getElementById('card-container').style.display = 'block';
            document.getElementById('controls-container').style.display = 'flex';
            fetchTutteDomande();
        }
    </script>
</body>
</html>
